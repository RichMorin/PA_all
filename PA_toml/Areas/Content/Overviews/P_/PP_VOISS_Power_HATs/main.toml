# con_ove|PP_VOISS_Power_HATs/main.toml

[ meta ]

  actions     = 'publish'
  id_str      = 'PP_VOISS_Power_HATs'
  title       = "VOISS - Power HATs"

[ meta.refs ]

  f_authors   = 'cat_peo|Rich_Morin'
  f_editors   = 'cat_peo|Rich_Morin'
  see_also    = 'con_ove|PP_VOISS_Power'

[ about ]

  precis      = "a discursion on USB power HATs"

  verbose     = '''
A variety of Hardware Attached on Top
([HAT]{https://www.raspberrypi.org/blog/introducing-raspberry-pi-hats})
boards can be used with the 3B+.
One of the most useful types, which I'm calling a Power HAT,
contains one or more [Lithium-ion batteries]{ext_wp|Lithium-ion_battery}
and some associated circuitry.
So, like a [USB power bank]{ext_wp|Battery_charger#Power_bank},
it can act as a dedicated uninterruptable power supply
([UPS]{ext_wp|Uninterruptible_power_supply}) for the computer.

However, because it is connected to the 3B+ using the
General purpose input-output ([GPIO]{
  https://en.wikipedia.org/wiki/Raspberry_Pi
  #General_purpose_input-output_(GPIO)_connector}) connector,
it can report its status to the operating system.
This information can then be used to support power management functions
(e.g., alerting the user, shutting down the computer).

Unfortunately, most  of the units I've found to date lack documentation
and/or software, have too little power for a 3B+, etc.
However, the "Pi-UpTime UPS 2.0", from Alchemy Power seems quite promising.
I'm still in the process of setting this up and evaluating it.
Meanwhile, I'll stay on the lookout for other alternatives.

The models I've found fall into two categories.
The first uses one or more cylindrical batteries;
the second uses a single, rectangular battery.
See below for a discussion of each approach.

### Cylindrical Battery

There are several [common formats]{ext_wp|List_of_battery_sizes
  #Lithium-ion_batteries_(rechargeable)} (e.g., 18650)
for cylindrical Lithium-ion batteries.
Their primary advantage is availability:
finding a replacement should be very easy.
Their primary disadvantage is bulk: the cylindrical format wastes quite a bit
of space, making the HAT larger than it would otherwise need to be.

The 18650 is 18 mm in diameter and 65 mm long.
Cells can be optimized for maximum current or maximum capacity, but not both.
The low-current cells we need for this use case are rated at up to 3600 mAh.

#### [Pi-UpTime UPS 2.0
     ]{http://alchemy-power.com/pi-uptime-ups-2-0}

[Alchemy Power]{http://alchemy-power.com}
manufactures several power management products.
Its proprietor, Percy Kawas,
has been very responsive to my (many!) requests for more information.
I wish more company representatives were as supportive as he has been.

The Pi-UpTime UPS 2.0 is designed to work with full-size Raspberry Pi computers.
It holds two (e.g., 3600 mAh) 18650 Lithium-ion cells, wired in parallel.
Consequently, it can run on one cell (with reduced battery lifetime).
The unit can also be used with Lithium iron phosphate
([LiFePO4]{ext_wp|Lithium_iron_phosphate_battery}) batteries.

The HAT contains a [TLA 202X]{https://www.ti.com/lit/ds/symlink/tla2024.pdf}.
This is a four-channel 12-bit analog to digital converter
([ADC]{ext_wp|Analog-to-digital_converter}) which monitors battery temperature,
as well as the input, output, and battery voltages.
A set of [Python]{ext_wp|Python_(programming_language)} scripts
is available to use this data.
I haven't had a chance to read or try out this code,
but I presume that it's a reasonable starting point for shutdown logic.

*Note:*
A card shipped with the Pi-UpTime UPS 2.0 says:
"Ensure [that] both batteries are fully charged or have [the]
same amount of charge before you insert them."
So, you'll need a way to pre-charge the batteries.
Also, because the power supply must handle both running and charging current,
Alchemy recommends using a 3.5A unit with a USB-C cable.

Here is some ordering information, including the tax and shipping I paid.
All told, this experiment has added about $100 to the system cost:

- [batteries]{https://www.18650batterystore.com/18650-p/samsung-36g.htm} (~$20)
- [charger]{https://www.amazon.com/dp/B07Q8KBSMK} ($4)
- [Pi-UpTime]{https://www.amazon.com/dp/B07YF45H2X} ($55)
- [ModMyPi Modular RPi 2/3 Case (Black)
  ]{https://thepihut.com/products/modmypi-modular-rpi-b-plus-case-black} ($8)
- [ModMyPi Modular RPi 2 Case - 10mm Spacer (Black)
  ]{https://thepihut.com/products/
    modmypi-modular-rpi-b-plus-case-10mm-spacer-black} ($5 for 2)

- [power supply]{https://www.amazon.com/dp/B07TYQRXTK} ($10)

##### Battery Notes

The 18650 designation covers a wide variety of batteries.
Some have built-in overcurrent protection; others do not.
Some have flat tops; others have button tops.
Some have high current capacity but limited power capacity (and vice versa).
Making matters worse, neither Alchemy Power nor any of its resellers
say much about what this device needs.  Grumble.

The Alchemy [FAQ]{http://alchemy-power.com/faq} indicates
that the Pi-UpTimeUPS and PiZ-UpTime should use unprotected batteries.
Percy Kawas says that most unprotected batteries have flat tops,
but that either the button top or flat top style will work.
That leaves us with the question of current vs. power capacity,
which I've attempted to estimate, as follows...

The 3B+ would like to have a 12.5W (5V at 2.5A) power source,
but the 18650 only supplies 3.6V.
Assuming 85% conversion efficiency (90% is typical),
a single cell would have to provide about 4A (12.5 / 0.85 / 3.6 = 4.08)
in order to yield 12.5W.
(Using two cells, we could cut this amount in half.)
In any event, a pair of cells that can supply 4A should be just fine.
This means that we can optimize for high power capacity,
which the (3600 mAh, 10A) Samsung batteries listed above certainly provide.

*Note:*
[The Best 18650 Battery and How to Avoid Buying Fakes
]{https://www.makeuseof.com/tag/18650-battery} covers a number
of issues and pitfalls associated with purchasing 18650 batteries.

##### Mounting Notes

This HAT is rather tall, due to the batteries, holders, and such.
Obviously, this precludes the use of any normal RasPi enclosure.
So, I ordered the ModMyPi modular enclosure (plus two spacers) from the PiHut.
The RasPi sits in the bottom of this enclosure, below the HAT.
There is no guarantee whether (let alone how well) this will work,
but it seemed worth taking a chance.
I'll report here once I've had a chance to try it out.

The RasPi's 40-pin connector has enough friction to hold boards together
under light handling and vibration, but it's better to add some bolts
and/or spacers.
The RasPi has four mounting holes, large enough for a 4-40 (or 2.5M) bolt.
FWIW, I'm using 3/4" long nylon spacers, 1" long bolts, etc.
One of the nuts didn't want to fit next to the battery holder,
so I put the bolts in with the heads up.

##### Power Consumption

*Note:*
Estimating power consumption on a real-world system is a chancy business.
A lot depends on what apps, daemons, and peripherals are involved.
So, the following should only be taken as rough estimates (YMMV).

A Lithium-ion cell produces about 3.6 VDC.
So, accounting for some conversion inefficiency,
a pair of 3600 mAh cells can supply nearly 5000 mAh at 5 VDC
(2 \* 3600 \* 3.6 \* 0.9 / 5.0 = 4665.6). 
According to [Power Consumption Benchmarks
]{https://www.pidramble.com/wiki/benchmarks/power-consumption},
a 3B+ needs about 350 mA when idle and 1000 mA at full throttle.
Because we won't be using the HDMI port and can shut down some daemons,
we can guess 333 mA as the idle current
and three times that for normal operation.

This tells us that a 3B+ can idle for about 15 hours,
perform useful work for perhaps 5 hours, and combinations thereof.
Of course, we can also shut the system down entirely for periods
when we don't expect to be using it,
carry a power bank and/or power supply to recharge the batteries, etc.
All told, this should give us reasonably acceptable battery lifetimes.

##### Miscellanea

The GPIO pins that stick up from the Pi-UpTime board are about 0.19" long.
This is far shorter than the .32" pins used on the RasPi
and might prevent them from being used (reliably) to attach another HAT.
Percy Kawas is looking into the possibility of finding a GPIO socket
with longer pins; here's hoping he finds something!

I found an old, pre-release version of the
[User Guide]{http://alchemy-power.com/wp-content/uploads/2016/11/
  Configuring-Alchemy-HATs-for-Pi.pdf} on the web.
I'd like to have a newer version, but the [FAQ]{http://alchemy-power.com/faq}
and the [data sheet]{http://alchemy-power.com/wp-content/uploads/2019/09/
  Pi-UpTimeUPSv2-DS-20190920.pdf} answered most of my questions.

#### [Vetco PI-UPTIMEUPS
     ]{https://vetco.net/products/uninterruptible-power-supply-ups-hat-
       for-raspberry-pi-pi-uptimeups?gclid=CjwKCAjwlovtBRBrEiwAG3XJ-
       xrskZk58lgQTXpaugrebN-iDNFEc-jNhdzzfPidM0VVyDFlnYvo4hoCnBUQAvD_BwE}

This HAT, which costs $70, appears to be the Alchemy Power Pi-UpTime UPS
(as opposed to the Pi-UpTime UPS 2.0).
It includes a pair of (3000 mAh) 18650 Lithium-ion cells.
The maximum current is said to be 1.7A, which is a bit low...
OTOH, Vetco may actually be selling the current model.

#### [Waveshare]{https://www.geekbuying.com/item/
      Waveshare-Li-ion-Battery-HAT-for-Raspberry-Pi-Blue-405193.html}

This HAT costs $19.
It holds one (800 mAh) 14500 Lithium-ion cell (not included).
It seems to be the same unit sold by AliExpress, et al.
Similarly, very little technical information is available for it.
Again, YMMV...

#### [XINLINDA KEJI]{https://www.aliexpress.com/item/32900341200.html}

This HAT (sold via [AliExpress]{https://www.aliexpress.com}
by "XINLINDA KEJI CO., LTD Store") costs $19.
It holds one (800 mAh) 14500 Lithium-ion cell (not included).
So far, very little technical information is available for it.
[YMMV]{https://www.lifewire.com/what-is-ymmv-2483722}...

### Rectangular Battery

None of the models listed below appear to have much in the way of documentation,
so I'm skipping them for the moment.
If you get one and have information you can share, please get in touch!

The batteries used in the listings below
are all a bit smaller than the RasPi in height and width
and about a centimeter thick.
They have no mounting fixtures and connect to the HAT
by means of a short cable and a plug.
So, you should use something (e.g., a [cable tie]{ext_wp|Cable_tie})
to keep it from falling out.
The other advantages and disadvantages of this battery format
are the converse of those mentioned above for the cylindrical format.
They are efficient in terms of space, but finding a replacement may be hard.

#### [Alibaba UPS HAT]{https://www.alibaba.com/product-detail/
      UPS-HAT-with-Battery-for-Raspberry_60672286249.html}
     
This HAT costs $19.
It contains a flat, 2500 mAh Lithium-ion battery,
sandwiched between a pair of circuit boards.
It comes with example code to detect and display the battery current, level,
voltage etc.
The maximum current is 2A, which is a bit low...

#### [Aostek Geekworm
     ]{https://www.bonanza.com/listings/Geekworm-UPS-HAT-Board-2500mAh-
       Lithium-Battery-For-Raspberry-Pi-3-Model-B-Pi/742175815
       ?search_term_id=91598702}

This HAT costs $26.
It contains a flat, 2500 mAh Lithium-ion battery,
sandwiched between a pair of circuit boards.
It comes with example code to detect and display the battery current, level,
voltage etc.

#### [Geekworm RPi
     ]{https://www.dx.com/p/geekworm-rpi-ups-pack-3-7v-3800mah-
       lithium-battery-battery-expansion-board-power-supply-charging-module-
       for-raspberry-pi-2085312.html}
     
This HAT costs $15.
It contains a flat, 3800 mAh Lithium-ion battery,
sandwiched between the RasPi and another (lower) circuit board.
There is a [wiki page]{http://www.raspberrypiwiki.com/index.php/RPi_UPSPack}
and a [Python script]{ext_gh|rcdrones/UPSPACK_V2},
but no English explanation or schematics.
Also, apparently, there is no way to monitor the battery level.
Again, YMMV...

#### [RPI Powerpack]{https://www.ebay.com/itm/
      Lithium-Battery-Expansion-Board-RPI-Powerpack-for-Raspberry-Pi-3-Model-B-Pi-2B-/282350503216}

This HAT costs $7.
It contains a flat, ? mAh Lithium-ion battery,
sandwiched between the RasPi and another (lower) circuit board.
It comes with example code to detect and display the battery current, level,
voltage etc.
So far, very little technical information is available for it.
Again, YMMV...

#### [VILROS PiJuice HAT
     ]{https://vilros.com/products/pijuice-hat-a-portable-power-platform-for-every-raspberry-pi?variant=29427567558750
       &currency=USD&gclid=CjwKCAjwlovtBRBrEiwAG3XJ-_Qrn8gYxWqsmPP4H_W14cYABvFbrXViL0siSN19mRwnI1p8qC1lOxoCir4QAvD_BwE}

This HAT costs $70.
It contains a flat, 1820 mAh Lithium-ion battery
and a [real time clock]{ext_wp|Real-time_clock}.
It comes with a "guide", but I don't know what information that contains.
'''

[ zoo ]

  snippets    = '...'
