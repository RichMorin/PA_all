# con_how|Perkify_APT_Details/main.toml

[ meta ]

  actions     = 'publish'
  id_str      = 'Perkify_APT_Details'
  title       = 'Perkify - APT Details'

[ meta.refs ]

  f_authors   = 'cat_peo|Rich_Morin'
  f_editors   = 'cat_peo|Rich_Morin'

[ about ]

  precis      = 'detailed discussion of APT packaging, etc.'

  verbose     = '''
Most of Perkify's added [packages]{con_ove|Perkify_Pkg_List} are installed
using Debian's Advanced Package Toolkit ([APT]{ext_wp|APT_(software)}).
The vast majority of these packages Just Work for our build system.
However, some packages don't exist already or have characteristics
(e.g., configuration dialogs) which cause problems for our build system.
In order to resolve these issues, we need to dig into APT a bit.

*Note:*
If you're looking for an introduction to APT usage on Perkify,
see [Perkify - APT]{con_how|Perkify_APT}.

### Example (Emacspeak)

[Emacspeak]{cat_sof|Emacspeak} is a blind-friendly version of Emacs.
We definitely want to include it in Perkify,
but its APT package uses a configuration dialog.
Let's see if there's anything we can do about that.

#### Web Pages

To get started, we need to find and peruse a few web pages.
Ubuntu's `emacspeak` package is based on Debian's,
so we may need to look in both places:

- Debian (buster)

  - [$url]{https://packages.debian.org/buster/emacspeak}</br>
    This page describes the `emacspeak` package.

  - [$url]{https://packages.debian.org/search?keywords=emacspeak}</br>
    This page supports searching for information on `emacspeak`.

- Ubuntu (e.g., 19.10; Eoan Ermine)

  - [$url]{https://launchpad.net/ubuntu/+source/emacspeak}</br>
    This page provides information of interest to Ubuntu developers.

  - [$url]{https://packages.ubuntu.comeoanemacspeak}</br>
    This page describes the `emacspeak` package.

  - [$url]{https://packages.ubuntu.com/search?keywords=emacspeak}</br>
    This page supports searching for information on `emacspeak`.

#### Files

Ubuntu's package page for `emacspeak` has a section
for "Download Source Package", containing three links:

- `[emacspeak_49.0+dfsg-3.dsc]`<br>
  This is the Debian source control file.
  It contains checksums, metadata, etc.

- `[emacspeak_49.0+dfsg.orig.tar.xz]`<br>
  This archive file contains the original content of the package.

- `[emacspeak_49.0+dfsg-3.debian.tar.xz]`<br>
  This archive file contains Debian's packaging additions.

After an archive has been downloaded,
it can be unpacked using [tar(1)]{https://linux.die.net/man/1/tar}:

    $ tar xf emacspeak_49.0+dfsg.orig.tar.xz
    $ tar xf emacspeak_49.0+dfsg-3.debian.tar.xz

This produces two directories, `debian` and `emacspeak_49.0`.
The `debian` directory contains several dozen files (gleep),
but no sub-directories (whew).
The `emacspeak_49.0` several sub-directories and several hundred files.
We won't be modifying anything in this directory tree,
but we may need to examine it to find out things about Emacspeak.

### Approach

- Try installing Emacspeak interactively.
- Examine the selections this defined.
- Add the selections to a control file.
- Load the control file in `add_ons`.

In order to install Emacspeak interactively, we need to emulate
the expected behavior of our `get_apt` script.
This presents us with a series of terminal-based GUI dialogs.
Edited for brevity, our terminal session looks something like this:

    sudo apt-get install -y emacspeak
    ...
    Default speech server:
      ...
      espeak
      sound card with Software DECtalk

                            <Ok>

    If a hardware device is used to generate speech, please enter the
    Unix device file associated with it ...                                                                                   â”‚ 
    
                            <Ok>      

We're installing [eSpeakNG]{cat_sof|eSpeakNG},
so `espeak` and "none" are plausible selections.
Assuming these are OK, how can we make them non-interactively?

I'm delighted you asked...
It turns out that, now that Emacspeak has been installed,
we can examine its configuration parameters as follows:

    vagrant@perkify-make:~$ sudo debconf-get-selections | more
    ...
    # Hardware port of the speech generation device:
    emacspeak	shared/emacspeak/port    string  none
    ...
    # Default speech server:
    emacspeak	shared/emacspeak/device  select  espeak
    ...

*Note:*
It isn't always obvious how to identify the configuration parameters
for a particular package.
For instance, the configuration dialog (and thus, its parameters)
may actually be generated by a dependency.

Having determined the configuration parameters,
we put them (suitably commented) into the `apt_presets` file:

    # Package Name    Database Key              Type      Value
    # ------------    ------------              ----      -----
    emacspeak     	  shared/emacspeak/port     string    none
    emacspeak         shared/emacspeak/device   select    espeak
    ...

The `add_ons` script can then load this file:

    debconf-set-selections apt_presets

### Resources

#### Debian Administrator's Handbook

The "Debian Administrator's Handbook" is a gold mine
of useful (albeit slightly dated) advice and information.
Here are some links:

- [Front matter
  ]{https://debian-handbook.info}
- [Chapter 1. The Debian Project
  ]{https://debian-handbook.info/browse/stable/the-debian-project.html}
- [Chapter 2. Presenting the Case Study
  ]{https://debian-handbook.info/browse/stable/case-study.html}
- [Chapter 3. Analyzing the Existing Setup and Migrating
  ]{https://debian-handbook.info/browse/stable/existing-setup.html}
- [Chapter 4. Installation
  ]{https://debian-handbook.info/browse/stable/installation.html}
- [Chapter 5. Packaging System: Tools and Fundamental Principles
  ]{https://debian-handbook.info/browse/stable/packaging-system.html}
- [Chapter 6. Maintenance and Updates: The APT Tools
  ]{https://debian-handbook.info/browse/stable/apt.html}
- [Section 6.8. Automatic Upgrades
  ]{https://debian-handbook.info/browse/stable/sect.automatic-upgrades.html}
- [Chapter 7. Solving Problems and Finding Relevant Information
  ]{https://debian-handbook.info/browse/stable/solving-problems.html}
- [Chapter 8. Basic Configuration: Network, Accounts, Printing...
  ]{https://debian-handbook.info/browse/stable/basic-configuration.html}
- [Chapter 9. Unix Services
  ]{https://debian-handbook.info/browse/stable/unix-services.html}
- [Chapter 10. Network Infrastructure
  ]{https://debian-handbook.info/browse/stable/network-infrastructure.html}
- [Chapter 11. Network Services:
   Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN
  ]{https://debian-handbook.info/browse/stable/network-services.html}
- [Chapter 12. Advanced Administration
  ]{https://debian-handbook.info/browse/stable/advanced-administration.html}
- [Chapter 13. Workstation
  ]{https://debian-handbook.info/browse/stable/workstation.html}
- [Chapter 14. Security
  ]{https://debian-handbook.info/browse/stable/security.html}
- [Chapter 15. Creating a Debian Package
  ]{https://debian-handbook.info/browse/stable/debian-packaging.html}
- [Chapter 16. Conclusion: Debian's Future
  ]{https://debian-handbook.info/browse/stable/conclusion.html}
- [Appendix A. Derivative Distributions
  ]{https://debian-handbook.info/browse/stable/derivative-distributions.html}
- [Appendix B. Short Remedial Course
  ]{https://debian-handbook.info/browse/stable/short-remedial-course.html}

#### Debian New Maintainers' Guide

The "Debian New Maintainers' Guide" contains a great deal of information on
creating Debian packages, etc.  Here are some links:

- [Front matter
  ]{https://www.debian.org/doc/manuals/maint-guide/index.en.html}
- [Chapter 1. Getting started The Right Way
  ]{https://www.debian.org/doc/manuals/maint-guide/start.en.html}
- [Chapter 2. First steps
  ]{https://www.debian.org/doc/manuals/maint-guide/first.en.html}
- [Chapter 3. Modifying the source
  ]{https://www.debian.org/doc/manuals/maint-guide/modify.en.html}
- [Chapter 4. Required files under the debian directory
  ]{https://www.debian.org/doc/manuals/maint-guide/dreq.en.html}
- [Chapter 5. Other files under the debian directory
  ]{https://www.debian.org/doc/manuals/maint-guide/dother.en.html}
- [Chapter 6. Building the package
  ]{https://www.debian.org/doc/manuals/maint-guide/build.en.html}
- [Chapter 7. Checking the package for errors
  ]{https://www.debian.org/doc/manuals/maint-guide/checkit.en.html}
- [Chapter 8. Updating the package
  ]{https://www.debian.org/doc/manuals/maint-guide/update.en.html}
- [Chapter 9. Uploading the package
  ]{https://www.debian.org/doc/manuals/maint-guide/upload.en.html}
- [Appendix A. Advanced packaging
  ]{https://www.debian.org/doc/manuals/maint-guide/advanced.en.html}

#### Packaging

- [Debian Packaging Tutorials
  ]{https://raphaelhertzog.com/debian-packaging}

#### Unattended Installation

- [Everything you need to know about conffiles:
   configuration files managed by dpkg
  ]{https://raphaelhertzog.com/2010/09/21/
    debian-conffile-configuration-file-managed-by-dpkg}

- [Perform an unattended installation of a Debian package
  ]{http://www.microhowto.info/howto/
    perform_an_unattended_installation_of_a_debian_package.html}

To be continued...
'''

[ zoo ]

  snippets    = '...'
